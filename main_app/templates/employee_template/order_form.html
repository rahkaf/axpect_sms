{% extends 'main_app/base.html' %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header"><h3 class="card-title">{{page_title}}</h3></div>
            <div class="card-body">
                <form method="post" id="orderForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>Customer</label>
                        <select name="customer_id" class="form-control" {% if jobcard and jobcard.customer_id %}disabled{% endif %}>
                            {% for c in customers %}
                            <option value="{{c.id}}" {% if jobcard and jobcard.customer_id == c.id %}selected{% endif %}>{{c.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Order Date</label>
                        <input type="date" name="order_date" class="form-control" value="{{now|date:'Y-m-d'}}">
                    </div>
                    <div class="form-group">
                        <label>Items</label>
                        <table class="table" id="itemsTable">
                            <thead><tr><th>Item</th><th>Cut</th><th>Rate</th><th>Qty (bales)</th><th></th></tr></thead>
                            <tbody></tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-secondary" id="addRow">Add Item</button>
                    </div>
                    <input type="hidden" name="items_json" id="items_json">
                    <button type="submit" class="btn btn-primary">Save Order</button>
                    <a href="{% url 'employee_jobcards' %}" class="btn btn-default">Cancel</a>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock content %}
{% block custom_js %}
<script>
const items = JSON.parse('{{ items|length|default:0 }}');
const itemOptions = `
    {% for it in items %}
    <option value="{{it.id}}">{{it.name}}</option>
    {% endfor %}
`;
document.getElementById('addRow').addEventListener('click', function(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><select class="form-control js-item">${itemOptions}</select></td>
        <td><input class="form-control js-cut" placeholder="e.g., 40s"></td>
        <td><input type="number" step="0.01" class="form-control js-rate" value="0"></td>
        <td><input type="number" step="0.01" class="form-control js-qty" value="0"></td>
        <td><button type="button" class="btn btn-xs btn-danger js-del">X</button></td>
    `;
    document.querySelector('#itemsTable tbody').appendChild(tr);
});
document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('js-del')){
        e.target.closest('tr').remove();
    }
});
document.getElementById('orderForm').addEventListener('submit', function(e){
    const rows = Array.from(document.querySelectorAll('#itemsTable tbody tr'));
    const data = rows.map(r => ({
        item_id: r.querySelector('.js-item').value,
        cut: r.querySelector('.js-cut').value,
        rate: r.querySelector('.js-rate').value,
        qty_bales: r.querySelector('.js-qty').value,
    }));
    document.getElementById('items_json').value = JSON.stringify(data);
});
</script>
{% endblock custom_js %}


