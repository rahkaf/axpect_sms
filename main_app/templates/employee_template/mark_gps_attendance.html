{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}Mark GPS Attendance{% endblock page_title %}

{% block custom_css %}
<style>
.attendance-card {
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
    margin-bottom: 20px;
}
.attendance-card:hover {
    transform: translateY(-2px);
}
.status-indicator {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-active { background-color: #28a745; }
.status-inactive { background-color: #dc3545; }
.status-pending { background-color: #ffc107; }
.gps-info {
    font-size: 0.9em;
    color: #6c757d;
}
.time-display {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 1.1em;
}
.action-btn {
    min-width: 150px;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 8px;
}
.location-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}
</style>
{% endblock custom_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Header Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card attendance-card bg-primary text-white">
                    <div class="card-body text-center">
                        <h2><i class="fas fa-map-marker-alt"></i> GPS Attendance Marking</h2>
                        <p class="mb-0">Mark your attendance with precise GPS location tracking</p>
                        <div class="mt-2">
                            <span class="badge badge-light" id="current-time"></span>
                            <span class="badge badge-light ml-2" id="current-date"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Status Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card attendance-card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-sign-in-alt"></i> Check In
                        </h4>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span class="info-box-number" id="checkin-status">
                                <span class="status-indicator status-inactive"></span>Not Checked In
                            </span>
                        </div>
                        <div class="time-display mb-2" id="checkin-time">--:--:--</div>
                        <div class="gps-info mb-3" id="checkin-location">No location recorded</div>
                        <button id="checkin-btn" class="btn btn-success action-btn">
                            <i class="fas fa-map-marker-alt"></i> Check In Now
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card attendance-card">
                    <div class="card-header bg-warning text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-sign-out-alt"></i> Check Out
                        </h4>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span class="info-box-number" id="checkout-status">
                                <span class="status-indicator status-inactive"></span>Not Checked Out
                            </span>
                        </div>
                        <div class="time-display mb-2" id="checkout-time">--:--:--</div>
                        <div class="gps-info mb-3" id="checkout-location">No location recorded</div>
                        <button id="checkout-btn" class="btn btn-warning action-btn" disabled>
                            <i class="fas fa-map-marker-alt"></i> Check Out Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GPS Status and Work Summary -->
        <div class="row">
            <div class="col-md-8">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-satellite-dish"></i> GPS Location Status
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" id="gps-status">
                            <i class="fas fa-spinner fa-spin"></i> Checking GPS availability...
                        </div>
                        
                        <div class="location-info" id="location-details" style="display: none;">
                            <h6><i class="fas fa-info-circle"></i> Current Location Details:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><strong>Latitude:</strong> <span id="current-lat">-</span></li>
                                        <li><strong>Longitude:</strong> <span id="current-lng">-</span></li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><strong>Accuracy:</strong> <span id="current-accuracy">-</span> meters</li>
                                        <li><strong>Updated:</strong> <span id="location-timestamp">-</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-chart-line"></i> Today's Summary
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="info-box mb-3">
                            <div class="info-box-content">
                                <span class="info-box-text">Hours Worked</span>
                                <span class="info-box-number time-display" id="hours-worked">0:00</span>
                            </div>
                        </div>
                        
                        <div class="info-box mb-3">
                            <div class="info-box-content">
                                <span class="info-box-text">Status</span>
                                <span class="info-box-number" id="day-status">
                                    <span class="badge badge-secondary">Pending</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <div class="info-box-content">
                                <span class="info-box-text">Department</span>
                                <span class="info-box-number">{{ user.employee.department.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Notes Section -->
        <div class="row" id="notes-section" style="display: none;">
            <div class="col-md-12">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-sticky-note"></i> End of Day Notes
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="checkout-notes">Describe your work accomplishments today (Optional)</label>
                            <textarea id="checkout-notes" class="form-control" rows="4" 
                                    placeholder="Example: Completed project documentation, attended team meeting, resolved 3 customer issues..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    let currentPosition = null;
    let checkedIn = false;
    let checkinTime = null;
    
    // Update current time and date
    function updateDateTime() {
        const now = new Date();
        $('#current-time').text(now.toLocaleTimeString());
        $('#current-date').text(now.toLocaleDateString());
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
    
    // Check GPS availability and get current position
    function initializeGPS() {
        if (!navigator.geolocation) {
            $('#gps-status').removeClass('alert-info').addClass('alert-danger')
                .html('<i class="fas fa-exclamation-triangle"></i> GPS is not supported by this browser. Please use a modern browser with location services.');
            return;
        }
        
        $('#gps-status').html('<i class="fas fa-spinner fa-spin"></i> Acquiring GPS location... (this may take a few seconds)');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentPosition = position;
                $('#gps-status').removeClass('alert-info').addClass('alert-success')
                    .html('<i class="fas fa-check-circle"></i> GPS location acquired successfully! You can now mark attendance.');
                
                // Update location details
                $('#current-lat').text(position.coords.latitude.toFixed(6));
                $('#current-lng').text(position.coords.longitude.toFixed(6));
                $('#current-accuracy').text(Math.round(position.coords.accuracy));
                $('#location-timestamp').text(new Date(position.timestamp).toLocaleTimeString());
                $('#location-details').show();
                
                // Enable check-in button
                $('#checkin-btn').prop('disabled', false);
            },
            function(error) {
                let errorMsg = '';
                let retryBtn = '<button class="btn btn-sm btn-warning mt-2" onclick="initializeGPS()"><i class="fas fa-redo"></i> Try Again</button>';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Location access denied. Please enable location services and refresh the page.' + retryBtn;
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Location information is unavailable. Please check your GPS settings.' + retryBtn;
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Location request timed out. Please try again.' + retryBtn;
                        break;
                    default:
                        errorMsg = 'An unknown error occurred while retrieving location.' + retryBtn;
                        break;
                }
                $('#gps-status').removeClass('alert-info').addClass('alert-danger')
                    .html('<i class="fas fa-exclamation-triangle"></i> ' + errorMsg);
                
                // Enable manual retry
                $('#checkin-btn').prop('disabled', false).text('Retry GPS & Check In');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,  // Reduced timeout to 10 seconds
                maximumAge: 30000  // Reduced cache time
            }
        );
    }
    
    // Check in function
    $('#checkin-btn').click(function() {
        console.log('Check-in button clicked');
        
        // If no GPS position, try to get it first
        if (!currentPosition) {
            console.log('No GPS position, trying to get location first');
            showNotification('Getting GPS Location', 'Acquiring your location first...', 'info');
            initializeGPS();
            setTimeout(function() {
                if (currentPosition) {
                    $('#checkin-btn').click();
                } else {
                    showNotification('GPS Required', 'Please wait for GPS location to be acquired or enable location services.', 'error');
                }
            }, 3000);
            return;
        }
        
        const button = $(this);
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Checking In...');
        
        const gpsString = `${currentPosition.coords.latitude},${currentPosition.coords.longitude}`;
        console.log('GPS String:', gpsString);
        console.log('CSRF Token:', csrftoken);
        
        // Try AJAX first
        const ajaxRequest = $.ajax({
            url: '/api/attendance/checkin/',
            method: 'POST',
            timeout: 10000, // Reduced to 10 seconds
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            data: JSON.stringify({
                gps: gpsString,
                city_id: null
            }),
            beforeSend: function() {
                console.log('Sending AJAX request...');
            },
            success: function(response) {
                console.log('AJAX Success:', response);
                checkedIn = true;
                checkinTime = new Date();
                
                // Update UI
                $('#checkin-status').html('<span class="status-indicator status-active"></span>Successfully Checked In');
                $('#checkin-time').text(checkinTime.toLocaleTimeString());
                $('#checkin-location').text(`Location: ${gpsString}`);
                
                // Enable checkout button and show notes
                $('#checkout-btn').prop('disabled', false);
                $('#notes-section').show();
                
                // Update status
                $('#day-status').html('<span class="badge badge-success">Active</span>');
                
                // Change button appearance
                button.html('<i class="fas fa-check"></i> Checked In')
                      .removeClass('btn-success').addClass('btn-secondary');
                
                // Show success message
                showNotification('Success!', 'You have successfully checked in with GPS location.', 'success');
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr, status, error);
                console.log('Response Text:', xhr.responseText);
                
                // Try fallback method
                if (status === 'timeout' || xhr.status === 0) {
                    console.log('Trying fallback method...');
                    tryFallbackCheckin(gpsString, button);
                } else {
                    button.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Check In Now');
                    
                    let errorMsg = 'Check-in failed';
                    if (status === 'timeout') {
                        errorMsg = 'Check-in timed out. Please try again.';
                    } else if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (xhr.status === 403) {
                        errorMsg = 'Permission denied. Please refresh the page and try again.';
                    } else if (xhr.status === 401) {
                        errorMsg = 'Please log in again.';
                    }
                    
                    showNotification('Check-in Failed', errorMsg + ' (Try refreshing the page)', 'error');
                }
            }
        });
        
        // Add a manual timeout as backup
        setTimeout(function() {
            if (ajaxRequest.readyState !== 4) {
                console.log('Manual timeout triggered');
                ajaxRequest.abort();
                tryFallbackCheckin(gpsString, button);
            }
        }, 12000);
    });
    
    // Fallback check-in method using form submission
    function tryFallbackCheckin(gpsString, button) {
        console.log('Trying fallback check-in method');
        
        // Create a hidden form
        const form = $('<form>', {
            method: 'POST',
            action: '/api/attendance/checkin/',
            style: 'display: none;'
        });
        
        // Add CSRF token
        form.append($('<input>', {
            type: 'hidden',
            name: 'csrfmiddlewaretoken',
            value: csrftoken
        }));
        
        // Add GPS data
        form.append($('<input>', {
            type: 'hidden',
            name: 'gps',
            value: gpsString
        }));
        
        // Add to body and submit
        $('body').append(form);
        
        // Handle form submission
        form.on('submit', function(e) {
            e.preventDefault();
            
            $.post('/api/attendance/checkin/', {
                gps: gpsString,
                csrfmiddlewaretoken: csrftoken
            })
            .done(function(response) {
                console.log('Fallback success:', response);
                location.reload(); // Reload page to show updated status
            })
            .fail(function(xhr) {
                console.error('Fallback failed:', xhr);
                button.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Check In Now');
                showNotification('Check-in Failed', 'Please refresh the page and try again.', 'error');
            })
            .always(function() {
                form.remove();
            });
        });
        
        form.submit();
    }
    
    // Check out function
    $('#checkout-btn').click(function() {
        if (!checkedIn) {
            alert('Please check in first before checking out.');
            return;
        }
        
        if (!currentPosition) {
            alert('Please wait for GPS location to be acquired before checking out.');
            return;
        }
        
        const button = $(this);
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Checking Out...');
        
        const gpsString = `${currentPosition.coords.latitude},${currentPosition.coords.longitude}`;
        const notes = $('#checkout-notes').val();
        
        $.ajax({
            url: '/api/attendance/checkout/',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            data: JSON.stringify({
                gps: gpsString,
                notes: notes
            }),
            success: function(response) {
                const checkoutTime = new Date();
                
                // Update UI
                $('#checkout-status').html('<span class="status-indicator status-active"></span>Successfully Checked Out');
                $('#checkout-time').text(checkoutTime.toLocaleTimeString());
                $('#checkout-location').text(`Location: ${gpsString}`);
                
                // Calculate hours worked
                if (checkinTime) {
                    const hoursWorked = (checkoutTime - checkinTime) / (1000 * 60 * 60);
                    const hours = Math.floor(hoursWorked);
                    const minutes = Math.floor((hoursWorked - hours) * 60);
                    $('#hours-worked').text(`${hours}:${minutes.toString().padStart(2, '0')}`);
                }
                
                // Update status
                $('#day-status').html('<span class="badge badge-primary">Complete</span>');
                
                // Change button appearance
                button.html('<i class="fas fa-check"></i> Checked Out')
                      .removeClass('btn-warning').addClass('btn-secondary');
                
                // Show success message
                showNotification('Success!', 'You have successfully checked out. Have a great day!', 'success');
            },
            error: function(xhr) {
                button.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Check Out Now');
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Check-out failed';
                showNotification('Check-out Failed', error, 'error');
            }
        });
    });
    
    // Notification function
    function showNotification(title, message, type) {
        let alertClass, icon;
        
        switch(type) {
            case 'success':
                alertClass = 'alert-success';
                icon = 'fa-check-circle';
                break;
            case 'error':
                alertClass = 'alert-danger';
                icon = 'fa-exclamation-triangle';
                break;
            case 'info':
                alertClass = 'alert-info';
                icon = 'fa-info-circle';
                break;
            case 'warning':
                alertClass = 'alert-warning';
                icon = 'fa-exclamation-circle';
                break;
            default:
                alertClass = 'alert-info';
                icon = 'fa-info-circle';
        }
        
        const notification = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas ${icon}"></i> <strong>${title}:</strong> ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        
        // Remove existing alerts first
        $('.alert').remove();
        
        // Insert at top of content
        $('.content .container-fluid').prepend(notification);
        
        // Auto-remove after 5 seconds (except for errors - keep longer)
        const timeout = type === 'error' ? 8000 : 5000;
        setTimeout(function() {
            $('.alert').fadeOut();
        }, timeout);
    }
    
    // Initialize GPS on page load
    initializeGPS();
    
    // Refresh GPS location every 5 minutes
    setInterval(initializeGPS, 5 * 60 * 1000);
});
</script>
{% endblock custom_js %}
