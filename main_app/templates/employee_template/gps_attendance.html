{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}GPS Attendance{% endblock page_title %}

{% block custom_css %}
<style>
.attendance-card {
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}
.attendance-card:hover {
    transform: translateY(-2px);
}
.status-indicator {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-active { background-color: #28a745; }
.status-inactive { background-color: #dc3545; }
.status-pending { background-color: #ffc107; }
.gps-info {
    font-size: 0.9em;
    color: #6c757d;
}
.time-display {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .attendance-card {
        margin-bottom: 15px;
    }
    
    .row .col-md-6,
    .row .col-md-8,
    .row .col-md-4 {
        margin-bottom: 20px;
    }
    
    .card-body {
        padding: 15px;
    }
    
    .btn-lg {
        padding: 0.6rem 1rem;
        font-size: 1rem;
    }
    
    .info-box {
        margin-bottom: 15px;
    }
    
    .info-box-content {
        padding: 10px;
    }
    
    .info-box-number {
        font-size: 1.2rem;
    }
}

@media (max-width: 576px) {
    .container-fluid {
        padding: 10px;
    }
    
    .card-header h3 {
        font-size: 1.1rem;
    }
    
    .card-body h4 {
        font-size: 1rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .info-box {
        text-align: center;
    }
    
    .status-indicator {
        display: block;
        margin: 5px auto;
    }
}

/* Fix info-box layout on mobile */
@media (max-width: 991.98px) {
    .row .col-md-3 {
        margin-bottom: 15px;
    }
    
    .info-box {
        display: flex;
        align-items: center;
    }
    
    .info-box-icon {
        width: 60px;
        height: 60px;
        flex-shrink: 0;
    }
    
    .info-box-content {
        flex-grow: 1;
        padding-left: 15px;
    }
}
</style>
{% endblock custom_css %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Current Status Row -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card attendance-card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title">
                            <i class="fas fa-map-marker-alt"></i> Today's Attendance Status
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-light" id="current-time"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-box bg-success">
                                    <span class="info-box-icon"><i class="fas fa-sign-in-alt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Check In Status</span>
                                        <span class="info-box-number" id="checkin-status">
                                            <span class="status-indicator status-inactive"></span>Not Checked In
                                        </span>
                                        <div class="time-display" id="checkin-time"></div>
                                        <div class="gps-info" id="checkin-location"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box bg-warning">
                                    <span class="info-box-icon"><i class="fas fa-sign-out-alt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Check Out Status</span>
                                        <span class="info-box-number" id="checkout-status">
                                            <span class="status-indicator status-inactive"></span>Not Checked Out
                                        </span>
                                        <div class="time-display" id="checkout-time"></div>
                                        <div class="gps-info" id="checkout-location"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card attendance-card">
                    <div class="card-body text-center">
                        <h4 class="text-success">
                            <i class="fas fa-clock"></i> Check In
                        </h4>
                        <p class="text-muted">Start your workday with GPS location</p>
                        <button id="checkin-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-map-marker-alt"></i> Check In Now
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Your location will be recorded
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card attendance-card">
                    <div class="card-body text-center">
                        <h4 class="text-warning">
                            <i class="fas fa-clock"></i> Check Out
                        </h4>
                        <p class="text-muted">End your workday with notes</p>
                        <button id="checkout-btn" class="btn btn-warning btn-lg" disabled>
                            <i class="fas fa-map-marker-alt"></i> Check Out Now
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> Add optional work notes
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GPS Status and Notes -->
        <div class="row">
            <div class="col-md-8">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-satellite-dish"></i> GPS Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" id="gps-status">
                            <i class="fas fa-spinner fa-spin"></i> Checking GPS availability...
                        </div>
                        <div id="location-details" style="display: none;">
                            <h6>Current Location Details:</h6>
                            <ul class="list-unstyled">
                                <li><strong>Latitude:</strong> <span id="current-lat">-</span></li>
                                <li><strong>Longitude:</strong> <span id="current-lng">-</span></li>
                                <li><strong>Accuracy:</strong> <span id="current-accuracy">-</span> meters</li>
                                <li><strong>Timestamp:</strong> <span id="location-timestamp">-</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-sticky-note"></i> Work Notes
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group" id="checkout-notes-section" style="display: none;">
                            <label for="checkout-notes">End of Day Notes</label>
                            <textarea id="checkout-notes" class="form-control" rows="4" 
                                    placeholder="Describe your work accomplishments today..."></textarea>
                        </div>
                        <div id="notes-placeholder">
                            <p class="text-muted text-center">
                                <i class="fas fa-info-circle"></i><br>
                                Notes section will be available when you check out
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Summary -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card attendance-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line"></i> Today's Summary
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-info"><i class="fas fa-clock"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Hours Worked</span>
                                        <span class="info-box-number" id="hours-worked">0:00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-success"><i class="fas fa-calendar-check"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Status</span>
                                        <span class="info-box-number" id="day-status">Pending</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-warning"><i class="fas fa-map-marked-alt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Locations</span>
                                        <span class="info-box-number" id="locations-count">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <span class="info-box-icon bg-danger"><i class="fas fa-building"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Department</span>
                                        <span class="info-box-number">{{ user.employee.department.name }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    let currentPosition = null;
    let checkedIn = false;
    let checkinTime = null;
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Update current time every second
    function updateCurrentTime() {
        const now = new Date();
        $('#current-time').text(now.toLocaleTimeString());
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();
    
    // Check GPS availability and get current position
    function initializeGPS() {
        if (!navigator.geolocation) {
            $('#gps-status').removeClass('alert-info').addClass('alert-danger')
                .html('<i class="fas fa-exclamation-triangle"></i> GPS is not supported by this browser.');
            return;
        }
        
        $('#gps-status').html('<i class="fas fa-spinner fa-spin"></i> Getting your location...');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentPosition = position;
                $('#gps-status').removeClass('alert-info').addClass('alert-success')
                    .html('<i class="fas fa-check-circle"></i> GPS location acquired successfully!');
                
                // Update location details
                $('#current-lat').text(position.coords.latitude.toFixed(6));
                $('#current-lng').text(position.coords.longitude.toFixed(6));
                $('#current-accuracy').text(Math.round(position.coords.accuracy));
                $('#location-timestamp').text(new Date(position.timestamp).toLocaleTimeString());
                $('#location-details').show();
                
                // Enable check-in button
                $('#checkin-btn').prop('disabled', false);
            },
            function(error) {
                let errorMsg = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Location access denied by user. Please enable location services.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Location request timed out.';
                        break;
                    default:
                        errorMsg = 'An unknown error occurred while retrieving location.';
                        break;
                }
                $('#gps-status').removeClass('alert-info').addClass('alert-danger')
                    .html('<i class="fas fa-exclamation-triangle"></i> ' + errorMsg);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }
    
    // Check in function
    $('#checkin-btn').click(function() {
        if (!currentPosition) {
            alert('Please wait for GPS location to be acquired.');
            return;
        }
        
        const button = $(this);
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Checking In...');
        
        const gpsString = `${currentPosition.coords.latitude},${currentPosition.coords.longitude}`;
        
        $.ajax({
            url: '/api/attendance/checkin/',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            data: JSON.stringify({
                gps: gpsString,
                city_id: null // You can add city selection if needed
            }),
            success: function(response) {
                checkedIn = true;
                checkinTime = new Date();
                
                // Update UI
                $('#checkin-status').html('<span class="status-indicator status-active"></span>Checked In');
                $('#checkin-time').text(checkinTime.toLocaleTimeString());
                $('#checkin-location').text(`Location: ${gpsString}`);
                
                // Enable checkout button
                $('#checkout-btn').prop('disabled', false);
                button.html('<i class="fas fa-check"></i> Checked In').addClass('btn-secondary').removeClass('btn-success');
                
                // Show notes section
                $('#checkout-notes-section').show();
                $('#notes-placeholder').hide();
                
                // Update day status
                $('#day-status').text('Active');
                $('#locations-count').text('1');
                
                alert('Successfully checked in with GPS location!');
            },
            error: function(xhr) {
                button.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Check In Now');
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Check-in failed';
                alert('Check-in failed: ' + error);
            }
        });
    });
    
    // Check out function
    $('#checkout-btn').click(function() {
        if (!checkedIn) {
            alert('Please check in first.');
            return;
        }
        
        if (!currentPosition) {
            alert('Please wait for GPS location to be acquired.');
            return;
        }
        
        const button = $(this);
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Checking Out...');
        
        const gpsString = `${currentPosition.coords.latitude},${currentPosition.coords.longitude}`;
        const notes = $('#checkout-notes').val();
        
        $.ajax({
            url: '/api/attendance/checkout/',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            data: JSON.stringify({
                gps: gpsString,
                notes: notes
            }),
            success: function(response) {
                const checkoutTime = new Date();
                
                // Update UI
                $('#checkout-status').html('<span class="status-indicator status-active"></span>Checked Out');
                $('#checkout-time').text(checkoutTime.toLocaleTimeString());
                $('#checkout-location').text(`Location: ${gpsString}`);
                
                button.html('<i class="fas fa-check"></i> Checked Out').addClass('btn-secondary').removeClass('btn-warning');
                
                // Calculate hours worked
                if (checkinTime) {
                    const hoursWorked = (checkoutTime - checkinTime) / (1000 * 60 * 60);
                    const hours = Math.floor(hoursWorked);
                    const minutes = Math.floor((hoursWorked - hours) * 60);
                    $('#hours-worked').text(`${hours}:${minutes.toString().padStart(2, '0')}`);
                }
                
                // Update day status
                $('#day-status').text('Complete');
                $('#locations-count').text('2');
                
                alert('Successfully checked out! Have a great day!');
            },
            error: function(xhr) {
                button.prop('disabled', false).html('<i class="fas fa-map-marker-alt"></i> Check Out Now');
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Check-out failed';
                alert('Check-out failed: ' + error);
            }
        });
    });
    
    // Initialize GPS on page load
    initializeGPS();
    
    // Refresh GPS location every 5 minutes
    setInterval(initializeGPS, 5 * 60 * 1000);
});
</script>
{% endblock custom_js %}
