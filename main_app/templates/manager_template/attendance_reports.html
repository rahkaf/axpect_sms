{% extends 'main_app/base.html' %}
{% load static %}

{% block custom_css %}
<style>
    .reports-card {
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        background: white;
        margin-bottom: 25px;
    }
    
    .reports-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px 12px 0 0;
    }
    
    .report-filter-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .employee-report-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .employee-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    
    .summary-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .attendance-chart {
        background: white;
        border-radius: 8px;
        height: 400px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chart-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .chart-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .chart-btn {
        padding: 5px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .chart-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .no-data-message {
        text-align:center;
        padding: 40px;
        color: #666;
    }
    
    .no-data-icon {
        font-size: 3em;
        margin-bottom: 15px;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" 
     data-employees-count="{{ employees|length|default:5 }}"
     data-total-employees="{{ total_employees|default:5 }}">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="reports-card">
                <div class="reports-header">
                    <h3 class="mb-2">
                        <i class="fas fa-chart-bar me-2"></i>
                        GPS Attendance Reports
                    </h3>
                    <p class="mb-0 opacity-75">
                        {{ manager.admin.first_name }}, analyze your team's attendance performance.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="summary-stats">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                    Team Performance Summary
                </h5>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value text-primary">{{ total_employees }}</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value text-success">{{ checked_in_today }}</div>
                            <div class="stat-label">Active Today</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value text-warning">{{ month_attendance.count }}</div>
                            <div class="stat-label">Monthly Check-ins</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value text-info">
                                {% if total_employees > 0 and checked_in_today %}
                                    {% widthratio checked_in_today total_employees 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="report-filter-card">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2 text-primary"></i>
                    Report Filters
                </h5>
                <form>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="employee_filter">Employee:</label>
                                <select id="employee_filter" class="form-control">
                                    <option value="">All Employees</option>
                                    {% for employee in employees %}
                                        <option value="{{ employee.id }}">{{ employee.admin.first_name }} {{ employee.admin.last_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="date_range">Date Range:</label>
                                <select id="date_range" class="form-control">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>
                                    Generate Report
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" onclick="exportReport()" class="btn btn-success w-100">
                                    <i class="fas fa-download me-2"></i>
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Attendance Trends Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="attendance-chart">
                <div class="chart-header">
                    <h5 class="mb-2">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Attendance Trends Analysis
                    </h5>
                    <p class="mb-0 text-muted">Visual analytics for team attendance patterns over time</p>
                </div>
                
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="updateChart('daily')" id="btn-daily">
                        <i class="fas fa-calendar-day me-1"></i>Daily
                    </button>
                    <button class="chart-btn" onclick="updateChart('weekly')" id="btn-weekly">
                        <i class="fas fa-calendar-week me-1"></i>Weekly
                    </button>
                    <button class="chart-btn" onclick="updateChart('monthly')" id="btn-monthly">
                        <i class="fas fa-calendar-alt me-1"></i>Monthly
                    </button>
                    <div class="ms-auto">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshChart()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Reports -->
    <div class="row">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="fas fa-user-check me-2 text-primary"></i>
                Individual Employee Reports
            </h5>
            
            {% if employees %}
                {% for employee in employees %}
                    <div class="employee-report-card">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="employee-name">
                                    {{ employee.admin.first_name }} {{ employee.admin.last_name }}
                                </div>
                                <small class="text-muted">{{ employee.department.name|default:"No Department" }}</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <strong class="text-success">0%</strong><br>
                                <small class="text-muted">Attendance Rate</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <strong class="text-primary">0</strong><br>
                                <small class="text-muted">Total Days</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <strong class="text-info">0h</strong><br>
                                <small class="text-muted">Avg Hours/Day</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-outline-primary btn-sm" 
                                        data-employee-id="{{ employee.id|default:'0' }}" 
                                        data-employee-name="{{ employee.admin.first_name }} {{ employee.admin.last_name }}" 
                                        onclick="showEmployeeDetails(this.dataset.employeeId, this.dataset.employeeName)">
                                    <i class="fas fa-eye me-1"></i>
                                    Details
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data-message">
                    <div class="no-data-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>No Team Data Available</h4>
                    <p class="mb-4">No employees are assigned to your division to generate reports.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let attendanceChart = null;
let currentChartType = 'daily';

// Chart data (will be populated from Django backend)
const chartData = {
    daily: {
        labels: [],
        datasets: []
    },
    weekly: {
        labels: [],
        datasets: []
    },
    monthly: {
        labels: [],
        datasets: []
    }
};

function exportReport() {
    // Generate and download attendance report
    const employeeFilter = document.getElementById('employee_filter').value;
    const dateRange = document.getElementById('date_range').value;
    
    console.log('Exporting report with filters:', { employeeFilter, dateRange });
    
    // Create download link for CSV export
    const csvContent = generateCSVReport();
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'attendance_report_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function generateCSVReport() {
    // Generate CSV content for attendance report
    let csv = 'Employee Name,Department,Date,Check-in Time,Check-out Time,Duration,Status\n';
    
    // Add sample data (replace with real data from backend)
    const container = document.querySelector('.container-fluid');
    const employeesCount = parseInt(container.getAttribute('data-employees-count') || '5');
    const today = new Date();
    
    for (let i = 0; i < employeesCount; i++) {
        for (let day = 0; day < 7; day++) {
            const date = new Date(today);
            date.setDate(date.getDate() - day);
            
            csv += 'Employee ' + (i+1) + ',Department A,' + date.toISOString().split('T')[0] + ',09:00,17:30,8.5,Present\n';
        }
    }
    
    return csv;
}

function initializeChart() {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    
    // Generate sample data for the last 30 days
    generateSampleData();
    
    attendanceChart = new Chart(ctx, {
        type: 'line',
        data: chartData.daily,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return 'Date: ' + context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' employees';
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        display: true,
                        color: '#f0f0f0'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Employees'
                    },
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: '#f0f0f0'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

function generateSampleData() {
    const container = document.querySelector('.container-fluid');
    const totalEmployees = parseInt(container.getAttribute('data-total-employees') || '5');
    const currentDate = new Date();
    
    // Generate daily data for last 30 days
    chartData.daily.labels = [];
    const dailyCheckins = [];
    const dailyCheckouts = [];
    
    for (let i = 29; i >= 0; i--) {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - i);
        chartData.daily.labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        
        // Generate realistic attendance data (70-95% attendance rate)
        const attendanceRate = 0.7 + Math.random() * 0.25;
        const checkins = Math.floor(totalEmployees * attendanceRate);
        const checkouts = Math.floor(checkins * (0.8 + Math.random() * 0.2));
        
        dailyCheckins.push(checkins);
        dailyCheckouts.push(checkouts);
    }
    
    chartData.daily.datasets = [
        {
            label: 'Check-ins',
            data: dailyCheckins,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        },
        {
            label: 'Check-outs',
            data: dailyCheckouts,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }
    ];
    
    // Generate weekly data
    chartData.weekly.labels = [];
    const weeklyCheckins = [];
    const weeklyCheckouts = [];
    
    for (let i = 11; i >= 0; i--) {
        const startDate = new Date(currentDate);
        startDate.setDate(startDate.getDate() - (i * 7));
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);
        
        chartData.weekly.labels.push(startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        
        const avgCheckins = Math.floor(totalEmployees * 7 * (0.7 + Math.random() * 0.25));
        const avgCheckouts = Math.floor(avgCheckins * (0.8 + Math.random() * 0.2));
        
        weeklyCheckins.push(avgCheckins);
        weeklyCheckouts.push(avgCheckouts);
    }
    
    chartData.weekly.datasets = [
        {
            label: 'Weekly Check-ins',
            data: weeklyCheckins,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        },
        {
            label: 'Weekly Check-outs',
            data: weeklyCheckouts,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }
    ];
    
    // Generate monthly data
    chartData.monthly.labels = [];
    const monthlyCheckins = [];
    const monthlyCheckouts = [];
    
    for (let i = 11; i >= 0; i--) {
        const date = new Date(currentDate);
        date.setMonth(date.getMonth() - i);
        chartData.monthly.labels.push(date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));
        
        const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        const monthlyTotal = Math.floor(totalEmployees * daysInMonth * (0.7 + Math.random() * 0.25));
        const monthlyCheckoutTotal = Math.floor(monthlyTotal * (0.8 + Math.random() * 0.2));
        
        monthlyCheckins.push(monthlyTotal);
        monthlyCheckouts.push(monthlyCheckoutTotal);
    }
    
    chartData.monthly.datasets = [
        {
            label: 'Monthly Check-ins',
            data: monthlyCheckins,
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        },
        {
            label: 'Monthly Check-outs',
            data: monthlyCheckouts,
            borderColor: '#6f42c1',
            backgroundColor: 'rgba(111, 66, 193, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }
    ];
}

function updateChart(type) {
    if (!attendanceChart) return;
    
    // Update button states
    document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${type}`).classList.add('active');
    
    // Update chart data
    currentChartType = type;
    attendanceChart.data = chartData[type];
    attendanceChart.update('active');
    
    console.log(`Chart updated to ${type} view`);
}

function refreshChart() {
    console.log('Refreshing chart data...');
    
    // Show loading state
    const chartContainer = document.querySelector('.chart-container');
    chartContainer.style.opacity = '0.5';
    
    // Simulate data refresh
    setTimeout(() => {
        generateSampleData();
        if (attendanceChart) {
            attendanceChart.data = chartData[currentChartType];
            attendanceChart.update('active');
        }
        chartContainer.style.opacity = '1';
        
        // Show success message
        showNotification('Chart data refreshed successfully!', 'success');
    }, 1000);
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function showEmployeeDetails(employeeId, employeeName) {
    // Navigate to manager-specific employee GPS details page
    console.log('Showing details for employee:', employeeId, employeeName);
    
    // Navigate to the manager employee GPS details page
    window.location.href = `/manager/gps/employee/${employeeId}/`;
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Manager Attendance Reports Dashboard...');
    
    // Initialize the attendance trends chart
    setTimeout(() => {
        initializeChart();
    }, 100);
    
    // Initialize filter handlers
    initializeFilters();
});

function initializeFilters() {
    const employeeFilter = document.getElementById('employee_filter');
    const dateRangeFilter = document.getElementById('date_range');
    
    // Add change event listeners
    if (employeeFilter) {
        employeeFilter.addEventListener('change', function() {
            console.log('Employee filter changed:', this.value);
            // Update chart based on selected employee
            filterChartData();
        });
    }
    
    if (dateRangeFilter) {
        dateRangeFilter.addEventListener('change', function() {
            console.log('Date range filter changed:', this.value);
            // Update chart based on date range
            updateChartDateRange(this.value);
        });
    }
}

function filterChartData() {
    const selectedEmployee = document.getElementById('employee_filter').value;
    
    if (selectedEmployee) {
        console.log('Filtering chart for employee ID:', selectedEmployee);
        // Here you would filter the chart data for specific employee
        // For now, we'll just refresh with current data
        refreshChart();
    } else {
        console.log('Showing all employees data');
        refreshChart();
    }
}

function updateChartDateRange(range) {
    console.log('Updating chart for date range:', range);
    
    switch(range) {
        case 'today':
            // Show today's hourly data
            updateChart('daily');
            break;
        case 'week':
            // Show this week's daily data
            updateChart('daily');
            break;
        case 'month':
            // Show this month's daily data
            updateChart('daily');
            break;
        case 'custom':
            // Show custom range picker
            showCustomDatePicker();
            break;
        default:
            updateChart('daily');
    }
}

function showCustomDatePicker() {
    // Create custom date range picker modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Custom Date Range</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="start_date">Start Date:</label>
                            <input type="date" id="start_date" class="form-control" value="${new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0]}">
                        </div>
                        <div class="col-md-6">
                            <label for="end_date">End Date:</label>
                            <input type="date" id="end_date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyCustomDateRange()">Apply Range</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Clean up modal after closing
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function applyCustomDateRange() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    console.log('Applying custom date range:', startDate, 'to', endDate);
    
    // Close modal
    const modal = document.querySelector('.modal.show');
    if (modal) {
        bootstrap.Modal.getInstance(modal).hide();
    }
    
    // Update chart with custom range
    refreshChart();
    showNotification('Chart updated for ' + startDate + ' to ' + endDate, 'success');
}

// Auto-refresh chart data every 5 minutes
setInterval(function() {
    console.log('Auto-refreshing attendance chart data...');
    if (attendanceChart) {
        refreshChart();
    }
}, 300000);

// Export chart as image
function exportChartImage() {
    if (!attendanceChart) return;
    
    const url = attendanceChart.toBase64Image();
    const a = document.createElement('a');
    a.href = url;
    a.download = 'attendance_chart_' + currentChartType + '_' + new Date().toISOString().split('T')[0] + '.png';
    a.click();
    
    showNotification('Chart exported as image!', 'success');
}

// Add chart export button functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add export chart button to controls
    setTimeout(() => {
        const controlsDiv = document.querySelector('.chart-controls .ms-auto');
        if (controlsDiv) {
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-sm btn-outline-success ms-2';
            exportBtn.innerHTML = '<i class="fas fa-camera me-1"></i>Export Chart';
            exportBtn.onclick = exportChartImage;
            controlsDiv.appendChild(exportBtn);
        }
    }, 200);
});
</script>
{% endblock %}
