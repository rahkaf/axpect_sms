{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}
Live GPS Map - Company Wide
{% endblock page_title %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Live GPS Map</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Home</a></li>
                    <li class="breadcrumb-item active">Live GPS Map</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- Info boxes -->
        <div class="row">
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-map-marker-alt"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">CEOs Online</span>
                        <span class="info-box-number" id="ceo-count">0</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-users"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Managers Online</span>
                        <span class="info-box-number" id="manager-count">0</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-success elevation-1"><i class="fas fa-user"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Employees Online</span>
                        <span class="info-box-number" id="employee-count">0</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-info elevation-1"><i class="fas fa-clock"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Last Updated</span>
                        <span class="info-box-number" id="last-updated">--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-map-marked-alt mr-1"></i>
                    Real-Time Staff Locations
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-sm btn-primary" id="refresh-map">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Legend -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-center">
                            <div class="mr-4">
                                <i class="fas fa-map-marker-alt text-danger"></i>
                                <span class="ml-1">CEO</span>
                            </div>
                            <div class="mr-4">
                                <i class="fas fa-map-marker-alt text-warning"></i>
                                <span class="ml-1">Manager</span>
                            </div>
                            <div class="mr-4">
                                <i class="fas fa-map-marker-alt text-success"></i>
                                <span class="ml-1">Employee</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div id="map" style="height: 600px; border-radius: 5px;"></div>
                
                <!-- Loading Indicator -->
                <div id="loading-indicator" class="text-center mt-3" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading GPS data...
                </div>
                
                <!-- No Data Message -->
                <div id="no-data-message" class="text-center mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        No staff members are currently online with GPS data.
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let markers = [];
let refreshInterval;

// Initialize map
function initMap() {
    // Start with world view
    map = L.map('map').setView([20, 0], 2); // World view
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Load initial data
    loadGPSData();
    
    // Set up auto-refresh every 30 seconds
    refreshInterval = setInterval(loadGPSData, 30000);
}

// Load GPS data from API
function loadGPSData() {
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('no-data-message').style.display = 'none';
    
    fetch('{% url "admin_gps_data_api" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading-indicator').style.display = 'none';
        
        if (data.success && data.data.length > 0) {
            updateMap(data.data);
            updateCounts(data.data);
            document.getElementById('no-data-message').style.display = 'none';
        } else {
            document.getElementById('no-data-message').style.display = 'block';
            clearMarkers();
            updateCounts([]);
        }
        
        // Update last updated time
        const now = new Date();
        document.getElementById('last-updated').textContent = 
            now.toLocaleTimeString('en-US', { hour12: false });
    })
    .catch(error => {
        console.error('Error loading GPS data:', error);
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('no-data-message').style.display = 'block';
    });
}

// Update map with new data
function updateMap(gpsData) {
    // Clear existing markers
    clearMarkers();
    
    // Add new markers
    gpsData.forEach(user => {
        const markerColor = getMarkerColor(user.marker_color);
        
        // Check if user is active (online status and last seen within 5 minutes)
        const isActive = isUserActive(user.last_seen, user.is_online);
        const activeIndicator = isActive ? '<div class="active-dot"></div>' : '';
        
        // Create custom icon with active indicator
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `
                <div class="marker-container">
                    <i class="fas fa-map-marker-alt" style="color: ${markerColor}; font-size: 24px;"></i>
                    ${activeIndicator}
                </div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });
        
        // Create marker
        const marker = L.marker([user.lat, user.lng], { icon: icon }).addTo(map);
        
        // Create popup content with active status
        const activeStatus = isActive ? 
            '<span class="badge badge-success"><i class="fas fa-circle"></i> Active</span>' : 
            '<span class="badge badge-secondary"><i class="fas fa-circle"></i> Inactive</span>';
        
        const popupContent = `
            <div class="text-center">
                <h6><strong>${user.name}</strong></h6>
                <p class="mb-1"><span class="badge badge-${getBadgeColor(user.marker_color)}">${user.role}</span> ${activeStatus}</p>
                <p class="mb-1"><small><i class="fas fa-clock"></i> Check-in: ${formatTime(user.checkin_time)}</small></p>
                <p class="mb-0"><small><i class="fas fa-eye"></i> Last seen: ${formatTime(user.last_seen)}</small></p>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });
    
    // Fit map to show all markers, but only if there are markers
    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    } else {
        // If no markers, keep world view
        map.setView([20, 0], 2);
    }
}

// Clear all markers
function clearMarkers() {
    markers.forEach(marker => {
        map.removeLayer(marker);
    });
    markers = [];
}

// Get marker color
function getMarkerColor(color) {
    const colors = {
        'red': '#dc3545',
        'yellow': '#ffc107',
        'green': '#28a745'
    };
    return colors[color] || '#6c757d';
}

// Get badge color for Bootstrap
function getBadgeColor(color) {
    const colors = {
        'red': 'danger',
        'yellow': 'warning',
        'green': 'success'
    };
    return colors[color] || 'secondary';
}

// Update counts
function updateCounts(gpsData) {
    const counts = {
        ceo: 0,
        manager: 0,
        employee: 0
    };
    
    gpsData.forEach(user => {
        if (user.role === 'CEO') counts.ceo++;
        else if (user.role === 'Manager') counts.manager++;
        else if (user.role === 'Employee') counts.employee++;
    });
    
    document.getElementById('ceo-count').textContent = counts.ceo;
    document.getElementById('manager-count').textContent = counts.manager;
    document.getElementById('employee-count').textContent = counts.employee;
}

// Check if user is active (online status and last seen within 5 minutes)
function isUserActive(lastSeenString, isOnline) {
    // First check if user is marked as online
    if (!isOnline) return false;
    
    // If no last seen data, consider inactive
    if (!lastSeenString) return false;
    
    const lastSeen = new Date(lastSeenString);
    const now = new Date();
    const diffMinutes = (now - lastSeen) / (1000 * 60); // Convert to minutes
    
    return diffMinutes <= 5; // Active if online AND last seen within 5 minutes
}

// Format time
function formatTime(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleTimeString('en-US', { hour12: false });
}

// Event listeners
document.getElementById('refresh-map').addEventListener('click', loadGPSData);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initMap);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>

<style>
.custom-marker {
    background: none;
    border: none;
}

.marker-container {
    position: relative;
    display: inline-block;
}

.active-dot {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    background-color: #ff0000;
    border: 2px solid #ffffff;
    border-radius: 50%;
    box-shadow: 0 0 4px rgba(255, 0, 0, 0.6);
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0% {
        box-shadow: 0 0 4px rgba(255, 0, 0, 0.6);
    }
    50% {
        box-shadow: 0 0 8px rgba(255, 0, 0, 0.8), 0 0 12px rgba(255, 0, 0, 0.4);
    }
    100% {
        box-shadow: 0 0 4px rgba(255, 0, 0, 0.6);
    }
}

.leaflet-popup-content {
    margin: 8px 12px;
}

.info-box-number {
    font-size: 1.5rem;
    font-weight: bold;
}

.badge .fas.fa-circle {
    font-size: 8px;
    margin-right: 4px;
}
</style>

{% endblock content %}
